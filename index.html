<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Whitelist System (Remote-capable)</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#111;color:#fff;text-align:center;padding-top:40px}
  #passwordPopup,#adminPanel{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#222;padding:18px;border-radius:10px;width:360px;border:2px solid #555;z-index:9999}
  input,select,button{padding:10px;margin-top:10px;border-radius:6px;border:none;font-size:15px}
  button{background:#4b78ff;color:#fff;cursor:pointer}
  button:hover{background:#3256c7}
  #playMarioBtn{display:none;margin-top:28px;padding:14px 22px;background:red;color:#fff;border-radius:10px;font-size:19px}
  .adminPlayBtn{background:red!important}
  .toggleOn{background:green!important;color:#000!important}
  .toggleOff{background:#4b78ff!important}
  .small{font-size:13px;color:#ccc;margin-top:8px}
  .row{margin-top:10px}
  #statusBanner{margin-bottom:8px;font-size:14px;color:#ddd}
</style>
</head>
<body>

<h1 id="lockedMessage">
This site is locked. You need whitelist from cam to play mario. Ask him to whitelist you for a while. Whitelisted people, please enjoy the game :). Please note i did not make this mario game jax, my friend did i repeat jax made this game (i made whitelist with ai).
</h1>

<div id="statusBanner"></div>

<!-- USER PLAY BUTTON -->
<button id="playMarioBtn" onclick="openProxyGame()">Play Mario</button>

<!-- PASSWORD POPUP -->
<div id="passwordPopup" role="dialog" aria-label="Admin password dialog">
  <h3>Enter Admin Password</h3>
  <input id="passwordInput" type="password" placeholder="Password" />
  <div class="row">
    <button onclick="checkPass()">Submit</button>
    <button onclick="closePasswordPopup()" style="margin-left:8px;background:#777">Cancel</button>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" role="dialog" aria-label="Admin Panel">
  <h2>Admin Panel</h2>

  <div class="row">
    <button class="adminPlayBtn" onclick="openProxyGame()">Play Mario (Admin)</button>
  </div>

  <h3 style="margin-top:16px">Whitelist Control</h3>

  <div class="row">
    <button id="allowToggle" class="toggleOff" onclick="togglePermanent()">Allow Everyone: OFF</button>
  </div>
  <div class="small">(Toggle ON = everyone allowed until toggled OFF)</div>

  <h3 style="margin-top:14px">Timed Access</h3>
  <div class="row">
    <select id="presetTime">
      <option value="5">Allow 5 minutes</option>
      <option value="15">Allow 15 minutes</option>
      <option value="30">Allow 30 minutes</option>
      <option value="45">Allow 45 minutes</option>
      <option value="60">Allow 60 minutes</option>
    </select>
    <button onclick="allowPreset()">Allow</button>
  </div>

  <div class="row">
    <input id="customMinutes" type="number" placeholder="Custom minutes" style="width:150px" />
    <button onclick="allowCustom()">Allow Custom</button>
  </div>

  <div class="small" id="expiresInfo"></div>

  <br />
  <div class="row">
    <button onclick="closeAdmin()">Close</button>
  </div>
</div>

<script>
/* ========== CONFIG ========== */
/* ADMIN password (don't share) */
const ADMIN_PASSWORD = "roongoon678";

/* GAME URL (opens in about:blank proxy) */
const GAME_URL = "https://fr-mario.vercel.app";

/* REMOTE DB URL (set this to your Firebase Realtime DB base URL, e.g.
   https://your-project-id-default-rtdb.firebaseio.com
   If left blank, code falls back to localStorage-only mode.
*/
const REMOTE_DB_URL = ""; // <-- PUT YOUR FIREBASE RTDB URL HERE to enable remote mode

/* The remote "key" path we'll use: <REMOTE_DB_URL>/whitelist.json
   Stored JSON shape:
    { type: "permanent" }             // permanent on
    { type: "timed", expire: 167... } // expire is ms timestamp
    {} or null                         // treated as locked
*/
const REMOTE_KEY_PATH = "/whitelist.json";

/* Polling interval (ms) when using remote mode */
const POLL_INTERVAL_MS = 2000;

/* Local storage key (fallback) */
const LOCAL_KEY = "whitelist_expire_v2";

/* ========== END CONFIG ========== */

/* helper to open game inside about:blank and inject iframe */
function openProxyGame() {
  try {
    const win = window.open("about:blank", "_blank");
    const html = `<!doctype html><html><head><meta charset="utf-8"><title>Game</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>html,body{height:100%;margin:0;background:#000}iframe{border:0; width:100%; height:100vh;}</style>
    </head><body><iframe src="${GAME_URL}" allowfullscreen></iframe></body></html>`;
    win.document.open();
    win.document.write(html);
    win.document.close();
  } catch (err) {
    alert("Popup blocked. Allow popups for this site.");
  }
}

/* ---------- Storage / Remote helpers ---------- */

function nowMs(){ return Date.now(); }

/* LOCAL helpers (fallback) */
function localSetExpire(value) { // value = "permanent" or numeric ms timestamp as string
  if (value === null) localStorage.removeItem(LOCAL_KEY);
  else localStorage.setItem(LOCAL_KEY, String(value));
}
function localGetRaw() { return localStorage.getItem(LOCAL_KEY); }

/* REMOTE helpers (fetch to JSON endpoint). Works with Firebase RTDB (no auth) or any endpoint that supports GET/PUT of JSON.
   We implement:
     remoteGet() -> { type: 'permanent' } | { type:'timed', expire:12345 } | null
     remoteSet(obj) -> writes obj or removes on null (uses DELETE if using Firebase)
*/
async function remoteGet() {
  if (!REMOTE_DB_URL) return null;
  try {
    const url = REMOTE_DB_URL.replace(/\/+$/, "") + REMOTE_KEY_PATH;
    const res = await fetch(url);
    if (!res.ok) return null;
    const j = await res.json();
    if (!j) return null;
    return j;
  } catch (e) {
    console.warn("remoteGet failed", e);
    return null;
  }
}
async function remoteSet(obj) {
  if (!REMOTE_DB_URL) return false;
  try {
    const url = REMOTE_DB_URL.replace(/\/+$/, "") + REMOTE_KEY_PATH;
    // Firebase RTDB: PUT the JSON at the path
    const res = await fetch(url, {
      method: obj === null ? "DELETE" : "PUT",
      headers: { "Content-Type": "application/json" },
      body: obj === null ? null : JSON.stringify(obj)
    });
    return res.ok;
  } catch (e) {
    console.warn("remoteSet failed", e);
    return false;
  }
}

/* High-level set/get that chooses remote (if configured) else local */
async function setState(obj) {
  if (REMOTE_DB_URL) {
    const ok = await remoteSet(obj);
    if (!ok) console.warn("remoteSet returned not-ok; falling back to local");
    // even if remoteSet fails, we also update local so admin sees change
    if (!ok) {
      if (obj === null) localSetExpire(null);
      else if (obj.type === "permanent") localSetExpire("permanent");
      else if (obj.type === "timed") localSetExpire(String(obj.expire));
    }
    return ok;
  } else {
    // local only
    if (obj === null) { localSetExpire(null); return true; }
    if (obj.type === "permanent") { localSetExpire("permanent"); return true; }
    if (obj.type === "timed") { localSetExpire(String(obj.expire)); return true; }
  }
}

/* high-level get */
async function getState() {
  if (REMOTE_DB_URL) {
    const remote = await remoteGet();
    if (remote) return remote;
    // fallback to local if remote empty
    const loc = localGetRaw();
    if (!loc) return null;
    if (loc === "permanent") return { type: "permanent" };
    const num = parseInt(loc,10);
    if (!isNaN(num)) return { type:"timed", expire: num };
    return null;
  } else {
    const loc = localGetRaw();
    if (!loc) return null;
    if (loc === "permanent") return { type: "permanent" };
    const num = parseInt(loc,10);
    if (!isNaN(num)) return { type:"timed", expire: num };
    return null;
  }
}

/* Determine "is allowed" quickly from a state object or local fallback */
function stateIsAllowed(obj) {
  if (!obj) return false;
  if (obj.type === "permanent") return true;
  if (obj.type === "timed" && typeof obj.expire === "number") return nowMs() < obj.expire;
  return false;
}

/* ---------- UI update logic ---------- */

const lockedMessageElement = document.getElementById("lockedMessage");
const playBtn = document.getElementById("playMarioBtn");
const allowToggleBtn = document.getElementById("allowToggle");
const expiresInfo = document.getElementById("expiresInfo");
const statusBanner = document.getElementById("statusBanner");
let latestState = null;

/* refresh UI from latestState */
function refreshUIFromState(s) {
  latestState = s;
  if (stateIsAllowed(s)) {
    lockedMessageElement.innerText = "Site Unlocked! Enjoy Mario.";
    playBtn.style.display = "inline-block";
    allowToggleBtn.innerText = "Allow Everyone: ON";
    allowToggleBtn.classList.remove("toggleOff");
    allowToggleBtn.classList.add("toggleOn");
    // expiry info
    if (s.type === "permanent") {
      expiresInfo && (expiresInfo.innerText = "Access: permanent (toggle OFF to re-lock)");
      statusBanner.innerText = REMOTE_DB_URL ? "Remote mode: ON (polling)" : "Local-only mode";
    } else if (s.type === "timed") {
      const remainingMs = s.expire - nowMs();
      if (remainingMs > 0) {
        const secs = Math.floor(remainingMs/1000);
        const hh = Math.floor(secs/3600);
        const mm = Math.floor((secs%3600)/60);
        const ss = secs%60;
        const timeStr = hh>0 ? `${hh}h ${mm}m ${ss}s` : `${mm}m ${ss}s`;
        expiresInfo && (expiresInfo.innerText = `Access expires in: ${timeStr}`);
      } else {
        expiresInfo && (expiresInfo.innerText = "Access expired (re-locking)...");
      }
      statusBanner.innerText = REMOTE_DB_URL ? "Remote mode: ON (polling)" : "Local-only mode";
    }
  } else {
    // locked
    lockedMessageElement.innerText = "This site is locked. You need whitelist from cam to play mario. Ask him to whitelist you for a while. Whitelisted people, please enjoy the game :). Please note i did not make this mario game jax, my friend did i repeat jax made this game (i made whitelist with ai).";
    playBtn.style.display = "none";
    allowToggleBtn.innerText = "Allow Everyone: OFF";
    allowToggleBtn.classList.remove("toggleOn");
    allowToggleBtn.classList.add("toggleOff");
    expiresInfo && (expiresInfo.innerText = "");
    statusBanner.innerText = REMOTE_DB_URL ? "Remote mode: ON (polling)" : "Local-only mode";
  }
}

/* initial load: read state once and update UI */
(async function initialLoad() {
  const s = await getState();
  refreshUIFromState(s);
})();

/* If remote is set, poll every POLL_INTERVAL_MS to pick up cross-device changes */
if (REMOTE_DB_URL) {
  setInterval(async () => {
    const s = await getState();
    // if state changed, update UI
    const sJson = JSON.stringify(s || null);
    const latestJson = JSON.stringify(latestState || null);
    if (sJson !== latestJson) refreshUIFromState(s);
  }, POLL_INTERVAL_MS);
} else {
  // local-only: still keep UI updating timer countdown every second
  setInterval(async () => {
    const s = await getState();
    refreshUIFromState(s);
  }, 1000);
}

/* ---------- Admin actions ---------- */

function closePasswordPopup(){ document.getElementById("passwordPopup").style.display = "none"; }

function checkPass() {
  const v = document.getElementById("passwordInput").value;
  if (v === ADMIN_PASSWORD) {
    document.getElementById("passwordPopup").style.display = "none";
    document.getElementById("adminPanel").style.display = "block";
  } else alert("Wrong password");
}

/* toggle permanent ON/OFF (writes remote if configured else local) */
async function togglePermanent(){
  // read current state
  const s = await getState();
  if (stateIsAllowed(s)) {
    // turn OFF: set state null
    const ok = await setState(null);
    if (!ok && REMOTE_DB_URL) alert("Remote write failed — state updated locally only.");
    refreshUIFromState(null);
    alert("Whitelist disabled. Site locked.");
  } else {
    // turn ON permanent
    const obj = { type: "permanent" };
    const ok = await setState(obj);
    if (!ok && REMOTE_DB_URL) alert("Remote write failed — state saved locally only.");
    refreshUIFromState(obj);
    alert("Whitelist enabled permanently. Everyone can play.");
  }
}

/* preset minutes allow */
async function allowPreset() {
  const mins = parseInt(document.getElementById("presetTime").value,10);
  if (!mins || mins <= 0) return alert("Pick valid preset");
  const expire = nowMs() + mins*60*1000;
  const obj = { type: "timed", expire: expire };
  const ok = await setState(obj);
  if (!ok && REMOTE_DB_URL) alert("Remote write failed — saved locally only.");
  refreshUIFromState(obj);
  alert(`Everyone allowed for ${mins} minutes.`);
}

/* custom minutes allow */
async function allowCustom(){
  const m = parseInt(document.getElementById("customMinutes").value,10);
  if (!m || m <= 0) return alert("Enter valid minutes");
  const expire = nowMs() + m*60*1000;
  const obj = { type: "timed", expire: expire };
  const ok = await setState(obj);
  if (!ok && REMOTE_DB_URL) alert("Remote write failed — saved locally only.");
  refreshUIFromState(obj);
  alert(`Everyone allowed for ${m} minutes.`);
}

function closeAdmin(){ document.getElementById("adminPanel").style.display = "none"; }

/* open password popup on ; key */
document.addEventListener("keydown", e=>{ if (e.key === ";"){ document.getElementById("passwordPopup").style.display = "block"; document.getElementById("passwordInput").value = ""; document.getElementById("passwordInput").focus(); }});
</script>
</body>
</html>
